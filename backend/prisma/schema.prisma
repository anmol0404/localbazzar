// This is your Prisma schema file for LocalBazaar
// Complete schema with all models, enums, and relations

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [postgis, vector]
}

// ==================== ENUMS ====================

enum UserRole {
  CUSTOMER
  SHOPKEEPER
  DRIVER
  ADMIN
}

enum UserStatus {
  ACTIVE
  BANNED
  PENDING_VERIFICATION
}

enum ShopStatus {
  ACTIVE
  CLOSED
  HOLIDAY
  PENDING_APPROVAL
  BANNED
}

enum OrderStatus {
  PENDING
  PENDING_SHOP_APPROVAL
  ACCEPTED_BY_SHOP
  DRIVER_ASSIGNED
  READY_FOR_PICKUP
  OUT_FOR_DELIVERY
  COMPLETED
  CANCELLED
  RETURNED
}

enum FulfillmentType {
  HOME_DELIVERY
  IN_STORE_PICKUP
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  ON_DELIVERY
  BANNED
}

enum NegotiationStatus {
  OPEN
  ACCEPTED
  REJECTED
  CLOSED
}

enum NotificationType {
  ORDER_UPDATE
  NEGOTIATION_ACCEPTED
  REVIEW_RECEIVED
  PROMOTION
  DRIVER_ASSIGNED
  DELIVERY_COMPLETED
  PAYMENT_SUCCESS
  SHOP_VERIFIED
  SYSTEM
}

enum ReportStatus {
  PENDING
  UNDER_REVIEW
  RESOLVED
  DISMISSED
}

enum ReportReason {
  SPAM
  FRAUD
  INAPPROPRIATE_CONTENT
  FAKE_PRODUCT
  HARASSMENT
  COPYRIGHT_VIOLATION
  OTHER
}

// ==================== USER & AUTH ====================

model User {
  id                  String       @id @default(uuid())
  email               String       @unique
  phone               String?      @unique
  passwordHash        String
  role                UserRole     @default(CUSTOMER)
  fullName            String
  profileImage        String?
  status              UserStatus   @default(ACTIVE)
  referralCode        String       @unique
  isEmailVerified     Boolean      @default(false)
  isPhoneVerified     Boolean      @default(false)
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  deletedAt           DateTime?
  
  addresses           Address[]
  shops               Shop[]       @relation("ShopOwner")
  orders              Order[]
  driverProfile       Driver?
  reviews             Review[]
  negotiations        Negotiation[]
  sentMessages        ChatMessage[]
  notifications       Notification[]
  submittedReports    Report[]         @relation("Reporter")

  packages            Package[]
  leaderboard         Leaderboard?
  postedBatches       FreelancingBatch[]
  assignedBatches     FreelancingBatch[] @relation("GigWorker")
  bids                Bid[]
  cart                Cart?
  wallet              Wallet?
  
  @@index([email])
  @@index([phone])
}

model Address {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  street      String
  city        String
  state       String
  pincode     String
  country     String   @default("India")
  isDefault   Boolean  @default(false)
  coordinates Unsupported("geometry(Point, 4326)")?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== SHOP & INVENTORY ====================

model Shop {
  id                  String       @id @default(uuid())
  ownerId             String
  owner               User         @relation("ShopOwner", fields: [ownerId], references: [id])
  name                String
  slug                String       @unique
  bio                 String?
  images              String[]
  contactEmail        String?
  contactPhone        String?
  
  address             String
  city                String
  pincode             String
  location            Unsupported("geometry(Point, 4326)")?
  
  operatingHours      Json
  fulfillmentTypes    FulfillmentType[]
  deliveryRadius      Int
  minOrderValue       Decimal      @default(0)
  
  returnPolicy        String?
  shippingPolicy      String?
  
  status              ShopStatus   @default(PENDING_APPROVAL)
  isVerified          Boolean      @default(false)
  verifiedAt          DateTime?
  
  rating              Decimal      @default(0)
  reviewCount         Int          @default(0)
  
  products            ShopProduct[]
  orders              Order[]
  subscriptions       Subscription[]
  negotiations        Negotiation[]
  reviews             Review[]
  promotions          Promotion[]
  packages            Package[]
  wallet              Wallet?

  payoutRequests      PayoutRequest[]
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  @@index([slug])
  @@index([status])
}

model Category {
  id                  String       @id @default(uuid())
  name                String       @unique
  slug                String       @unique
  image               String?
  parentId            String?
  parent              Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children            Category[]   @relation("CategoryHierarchy")
  
  masterProducts      MasterProduct[]
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model Brand {
  id                  String       @id @default(uuid())
  name                String       @unique
  slug                String       @unique
  logo                String?
  website             String?
  
  masterProducts      MasterProduct[]
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model MasterProduct {
  id                  String       @id @default(uuid())
  name                String
  slug                String       @unique
  description         String?
  
  brandId             String?
  brand               Brand?       @relation(fields: [brandId], references: [id])
  
  categoryId          String
  category            Category     @relation(fields: [categoryId], references: [id])
  
  images              String[]
  defaultSpecifications Json?
  
  isApproved          Boolean      @default(false)
  
  shopProducts        ShopProduct[]
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  @@index([name])
}

model ShopProduct {
  id                  String       @id @default(uuid())
  shopId              String
  shop                Shop         @relation(fields: [shopId], references: [id])
  
  masterProductId     String?
  masterProduct       MasterProduct? @relation(fields: [masterProductId], references: [id])
  
  name                String
  slug                String
  description         String?
  
  price               Decimal
  stock               Int
  reservedStock       Int          @default(0)
  discount            Decimal      @default(0)
  negotiationRange    Json?
  
  images              String[]
  
  specifications      Json?
  isActive            Boolean      @default(true)
  
  embedding           Unsupported("vector(1536)")?
  
  variants            ProductVariant[]
  orderItems          OrderItem[]
  negotiations        Negotiation[]
  reviews             Review[]
  cartItems           CartItem[]

  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  @@unique([shopId, slug])
  @@index([name])
  @@index([isActive])
}

model ProductVariant {
  id                  String       @id @default(uuid())
  shopProductId       String
  shopProduct         ShopProduct  @relation(fields: [shopProductId], references: [id])
  
  name                String
  sku                 String?
  price               Decimal?
  stock               Int
  
  specifications      Json
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model Review {
  id                  String       @id @default(uuid())
  userId              String
  user                User         @relation(fields: [userId], references: [id])
  
  shopId              String?
  shop                Shop?        @relation(fields: [shopId], references: [id])
  
  productId           String?
  product             ShopProduct? @relation(fields: [productId], references: [id])
  
  rating              Int
  comment             String?
  images              String[]
  

  
  createdAt           DateTime     @default(now())
}

model Promotion {
  id                  String       @id @default(uuid())
  shopId              String
  shop                Shop         @relation(fields: [shopId], references: [id])
  
  code                String       @unique
  description         String?
  discountType        String
  discountValue       Decimal
  minOrderValue       Decimal      @default(0)
  maxDiscount         Decimal?
  
  startDate           DateTime
  endDate             DateTime
  isActive            Boolean      @default(true)
  
  usageLimit          Int?
  usedCount           Int          @default(0)
  
  createdAt           DateTime     @default(now())
}

model MandiRecord {
  id                  String       @id @default(uuid())
  commodity           String
  variety             String?
  market              String
  state               String
  price               Decimal
  unit                String
  date                DateTime
  
  createdAt           DateTime     @default(now())
}

// ==================== SUBSCRIPTIONS ====================

model Plan {
  id                  String       @id @default(uuid())
  name                String       @unique
  description         String?
  price               Decimal
  currency            String       @default("INR")
  durationDays        Int
  features            String[]
  isActive            Boolean      @default(true)
  priority            Int          @default(0)
  
  subscriptions       Subscription[]
  packages            Package[]
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model Subscription {
  id                  String       @id @default(uuid())
  shopId              String
  shop                Shop         @relation(fields: [shopId], references: [id])
  planId              String
  plan                Plan         @relation(fields: [planId], references: [id])
  
  startDate           DateTime     @default(now())
  endDate             DateTime
  status              String
  autoRenew           Boolean      @default(false)
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model Package {
  id                  String       @id @default(uuid())
  userId              String
  user                User         @relation(fields: [userId], references: [id])
  shopId              String
  shop                Shop         @relation(fields: [shopId], references: [id])
  planId              String
  plan                Plan         @relation(fields: [planId], references: [id])
  
  amount              Decimal
  currency            String       @default("INR")
  status              PaymentStatus
  invoiceUrl          String?
  transactionId       String?
  
  billingAddress      Json?
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

// ==================== GAMIFICATION ====================

model Leaderboard {
  id                  String       @id @default(uuid())
  userId              String       @unique
  user                User         @relation(fields: [userId], references: [id])
  
  type                String
  period              String
  score               Int          @default(0)
  rank                Int?
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

// ==================== GIG ECONOMY ====================

model FreelancingBatch {
  id                  String       @id @default(uuid())
  postedById          String
  postedBy            User         @relation(fields: [postedById], references: [id])
  
  title               String
  description         String
  skillsRequired      String[]
  budget              Decimal?
  deadline            DateTime?
  
  status              String
  assignedToId        String?
  assignedTo          User?        @relation("GigWorker", fields: [assignedToId], references: [id])
  
  bids                Bid[]
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model Bid {
  id                  String       @id @default(uuid())
  batchId             String
  batch               FreelancingBatch @relation(fields: [batchId], references: [id])
  userId              String
  user                User         @relation(fields: [userId], references: [id])
  
  amount              Decimal
  message             String?
  
  createdAt           DateTime     @default(now())
}

// ==================== CART & WALLET ====================

model Cart {
  id                  String       @id @default(uuid())
  userId              String       @unique
  user                User         @relation(fields: [userId], references: [id])
  
  items               CartItem[]
  
  updatedAt           DateTime     @updatedAt
}

model CartItem {
  id                  String       @id @default(uuid())
  cartId              String
  cart                Cart         @relation(fields: [cartId], references: [id])
  
  shopProductId       String
  shopProduct         ShopProduct  @relation(fields: [shopProductId], references: [id])
  
  quantity            Int
  price               Decimal
  selectedAttributes  Json?
}

model Wallet {
  id                  String       @id @default(uuid())
  userId              String?      @unique
  user                User?        @relation(fields: [userId], references: [id])
  shopId              String?      @unique
  shop                Shop?        @relation(fields: [shopId], references: [id])
  
  balance             Decimal      @default(0)
  currency            String       @default("INR")
  isActive            Boolean      @default(true)
  
  transactions        WalletTransaction[]
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model WalletTransaction {
  id                  String       @id @default(uuid())
  walletId            String
  wallet              Wallet       @relation(fields: [walletId], references: [id])
  
  amount              Decimal
  type                String
  referenceId         String?
  referenceType       String?
  description         String?
  
  status              String
  
  createdAt           DateTime     @default(now())
}

// ==================== NOTIFICATIONS & REPORTS ====================

model Notification {
  id                  String       @id @default(uuid())
  userId              String
  user                User         @relation(fields: [userId], references: [id])
  
  type                NotificationType
  title               String
  message             String
  data                Json?
  
  isRead              Boolean      @default(false)
  readAt              DateTime?
  
  createdAt           DateTime     @default(now())
  
  @@index([userId, isRead])
  @@index([createdAt])
}

enum ReportTargetType {
  USER
  SHOP
  PRODUCT
  REVIEW
  MESSAGE
  NEGOTIATION
}

model Report {
  id                  String       @id @default(uuid())
  
  reporterId          String
  reporter            User         @relation("Reporter", fields: [reporterId], references: [id])
  
  targetType          ReportTargetType
  targetId            String
  metadata            Json?
  
  reason              ReportReason
  description         String
  evidence            Json?
  
  status              ReportStatus @default(PENDING)
  resolvedBy          String?
  resolutionNotes     String?
  resolvedAt          DateTime?
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  @@index([status])
  @@index([reporterId])
  @@index([targetType, targetId])
}

// ==================== ORDERS & PAYMENTS ====================

model Order {
  id                  String       @id @default(uuid())
  customerId          String
  customer            User         @relation(fields: [customerId], references: [id])
  shopId              String
  shop                Shop         @relation(fields: [shopId], references: [id])
  
  status              OrderStatus  @default(PENDING)
  fulfillmentType     FulfillmentType
  
  subtotal            Decimal
  deliveryFee         Decimal
  tax                 Decimal
  totalAmount         Decimal
  
  driverId            String?
  driver              Driver?      @relation(fields: [driverId], references: [id])
  deliveryAddress     Json
  deliveryCode        String?
  
  items               OrderItem[]
  payment             Payment?
  negotiationId       String?
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  @@index([deliveryCode])
}

model OrderItem {
  id                  String       @id @default(uuid())
  orderId             String
  order               Order        @relation(fields: [orderId], references: [id])
  productId           String
  product             ShopProduct  @relation(fields: [productId], references: [id])
  
  quantity            Int
  price               Decimal
  productName         String
}

model Payment {
  id                  String       @id @default(uuid())
  orderId             String       @unique
  order               Order        @relation(fields: [orderId], references: [id])
  
  amount              Decimal
  currency            String       @default("INR")
  status              PaymentStatus
  
  gateway             String
  gatewayPaymentId    String?
  gatewayResponse     Json?
  
  method              String?
  failureReason       String?
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  @@index([status])
  @@index([orderId])
}

// ==================== LOGISTICS ====================

model Driver {
  id                  String       @id @default(uuid())
  userId              String       @unique
  user                User         @relation(fields: [userId], references: [id])
  
  status              DriverStatus @default(INACTIVE)
  isAvailable         Boolean      @default(false)
  currentLocation     Unsupported("geometry(Point, 4326)")?
  
  vehicleDetails      Json
  rating              Decimal      @default(5.0)
  
  orders              Order[]
  
  updatedAt           DateTime     @updatedAt
}

// ==================== NEGOTIATION & CHAT ====================

model Negotiation {
  id                  String       @id @default(uuid())
  customerId          String
  customer            User         @relation(fields: [customerId], references: [id])
  shopId              String
  shop                Shop         @relation(fields: [shopId], references: [id])
  productId           String
  product             ShopProduct  @relation(fields: [productId], references: [id])
  
  initialPrice        Decimal
  currentOffer        Decimal?
  
  status              NegotiationStatus @default(OPEN)
  finalPrice          Decimal?
  
  messages            ChatMessage[]
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
}

model ChatMessage {
  id                  String       @id @default(uuid())
  negotiationId       String
  negotiation         Negotiation  @relation(fields: [negotiationId], references: [id])
  
  senderId            String
  sender              User         @relation(fields: [senderId], references: [id])
  
  message             String
  offerPrice          Decimal?
  isSystemMessage     Boolean      @default(false)
  
  createdAt           DateTime     @default(now())
  
  @@index([negotiationId])
  @@index([createdAt])
}

// ==================== FINANCE ====================

enum PayoutStatus {
  PENDING
  APPROVED
  REJECTED
  PROCESSED
}

model PayoutRequest {
  id                  String       @id @default(uuid())
  shopId              String
  shop                Shop         @relation(fields: [shopId], references: [id])
  
  amount              Decimal
  currency            String       @default("INR")
  status              PayoutStatus @default(PENDING)
  
  requestedAt         DateTime     @default(now())
  processedAt         DateTime?
  processedBy         String?      // Admin ID
  
  transactionId       String?
  notes               String?
  
  @@index([shopId])
  @@index([status])
}

model PlatformSettings {
  id                  String       @id @default(uuid())
  key                 String       @unique
  value               Json
  description         String?
  
  updatedAt           DateTime     @updatedAt
}
